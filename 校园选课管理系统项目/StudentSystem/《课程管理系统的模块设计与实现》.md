# 《课程管理系统的模块设计与实现》

我将把关键代码描述中的具体代码替换为文字逻辑，并结合方法名、对象名等元素，重新梳理各模块的关键代码逻辑，让内容更易理解。

### 模块一：查看课程目录

#### （1）功能简述

学生 / 教师可在课程目录页面浏览所有可选课程，支持按课程名称、学科分类、授课教师等关键词搜索课程，点击课程可查看详细信息（含课程简介、学分、课时、先修课要求、上课时间地点、剩余名额等），并可通过筛选条件（如学分范围、上课时段）快速定位目标课程。

#### （2）应用场景简述

**场景 1**：学生在选课周期开始前，通过课程目录了解本学期开设课程，规划选课计划（如根据专业培养方案筛选必修 / 选修课）。

**场景 2**：教师 / 管理员需核对课程信息准确性，或向学生推荐特定课程（如热门选修课、新开实验课）。

**场景 3**：学生在退课 / 补课后，通过目录重新搜索符合条件的替代课程。

#### （3）设计思路

**设计目标**：解决 “课程信息不对称” 问题，提供高效的课程检索与详情查看功能，辅助用户决策。

**功能架构**：

**数据层**：从课程表（`course`）获取基础数据（课程 ID、名称、学分、授课教师等），从教室表（`classroom`）关联上课地点，从教师表（`teacher`）关联教师简介。

**交互层**：支持关键词搜索（模糊匹配）、多条件筛选（学分≥2、上课时间≠周一上午）、课程卡片式展示（含快捷操作按钮 “加入选课单”）。

**反馈层**：实时显示课程剩余名额（红色警示 “仅剩 2 席”）、先修课未满足提示（灰色置灰 “暂不可选”）。

#### （4）具体实现

**数据来源与结构**：

课程表`course`字段：`_id`（课程 ID）、`courseName`、`credit`、`period`、`prerequisite`（先修课 ID 数组）、`teacherId`、`classroomId`、`maxStudent`、`currentStudent`（当前选课人数）、`timeSlot`（上课时段，如 “周二 3-4 节”）。

**核心流程**：

用户进入课程目录页，触发`onLoad`事件，调用`getCourseList`云函数获取全量课程数据，按`updateTime`倒序排序后渲染至页面。

用户在搜索框输入关键词，触发`searchCourse`函数，使用数据库正则表达式匹配（`db.RegExp`）功能，对课程名称（`courseName`）或教师姓名（通过`teacherId`关联教师表`teacher`中的`name`字段）进行模糊匹配，返回匹配结果。

用户点击课程卡片，携带`courseId`参数跳转至课程详情页，通过`get`方法从课程表（`course`）中获取对应课程的详细信息，并关联查询教师表（`teacher`）获取教师信息。

#### （5）关键代码实现描述

**加载课程列表**：页面加载时（`onLoad`事件），调用`getCourseList`云函数从数据库获取所有课程数据，将结果存储在页面数据对象（`data`）的`courseList`属性中，用于页面渲染。

**关键词搜索**：用户输入关键词后，`searchCourse`函数首先判断关键词是否为空，若为空则重新调用`getCourseList`函数加载全部课程；若不为空，则使用`db.RegExp`进行正则匹配，在课程表（`course`）中查找课程名称或教师姓名符合条件的课程，将匹配结果更新到`courseList`中，实现搜索功能。

**跳转课程详情**：用户点击课程卡片时，触发跳转函数，将课程 ID（`courseId`）作为参数传递，通过页面跳转方法（`navigateTo`）跳转到课程详情页，并在详情页通过课程 ID 从数据库获取并展示课程详细信息。

**异常处理**：

搜索关键词为空时，默认加载全部课程，避免报错。

课程详情页加载失败时，调用提示方法（`showToast`）显示 “课程信息加载失败” 提示，并允许用户重试。

### 模块二：选课管理

#### （1）功能简述

学生可在选课开放期内提交选课申请，系统自动校验选课资格（如先修课是否完成、剩余名额是否充足），支持 “立即选课”“加入选课单批量提交”“查看已选课程”“退课” 等操作；选课结果实时同步，退课后释放名额至课程池。

#### （2）应用场景简述

**场景 1**：学生在选课开放首日，通过 “选课单” 批量勾选 5 门课程，点击 “提交” 后系统逐一校验并返回成功 / 失败结果（如某课程已满员则提示）。

**场景 2**：学生因时间冲突，对已选课程执行 “退课” 操作，释放名额给其他学生。

**场景 3**：选课结束后，学生在 “已选课程” 列表查看最终选课结果，作为学期课表依据。

#### （3）设计思路

**设计目标**：实现 “高效选课 - 实时校验 - 状态同步” 闭环，确保选课逻辑的原子性（避免超卖）和资格合法性（先修课校验）。

**功能架构**：

**资格校验**：

先修课校验：查询学生成绩表（`score`），确认先修课是否达标（成绩≥60 分）。

名额校验：检查课程表`currentStudent < maxStudent`。

**事务处理**：使用云数据库事务功能，将课程表（`course`）中学科名额更新操作与学生选课表（`studentCourse`）中添加选课记录操作进行原子化处理，确保选课与名额扣减同步成功或失败。

**状态管理**：已选课程状态分为 “待确认”（选课开放期内可修改）、“已锁定”（选课结束后不可退课）。

#### （4）具体实现

**数据来源与结构**：

学生选课表`studentCourse`字段：`_id`（选课记录 ID）、`studentId`、`courseId`、`status`（0 - 待提交，1 - 已选，2 - 退课）、`applyTime`（申请时间）。

**核心流程**：

学生在课程目录页点击 “立即选课” 或在选课单勾选课程，触发`submitCourse`函数，携带`courseId`和`studentId`（从用户信息存储对象`wx.getStorageSync('userInfo')`中获取）。

系统先通过`checkEligibility`函数进行校验：

先修课校验：在学生成绩表（`score`）中查询`studentId`对应的先修课成绩记录，确认成绩是否达标（≥60 分）。

名额校验：从课程表（`course`）中获取对应课程的当前选课人数（`currentStudent`）和最大容量（`maxStudent`），判断是否有名额。

若校验通过，启动数据库事务：

使用`update`方法更新课程表（`course`）中对应课程的`currentStudent`字段，使其值加 1。

使用`add`方法在学生选课表（`studentCourse`）中添加一条选课记录，记录`studentId`、`courseId`、状态为 “已选”（`status=1`）及申请时间（`applyTime`）。

退课时，调用`cancelCourse`函数，启动反向事务：课程表（`course`）中`currentStudent`减 1，学生选课表（`studentCourse`）中对应记录的`status`置为 2（退课）。

#### （5）关键代码实现描述

**选课提交函数**：`submitCourse`函数接收课程 ID（`courseId`）和学生 ID（`studentId`），首先调用`checkEligibility`函数进行先修课和名额校验。若先修课未通过，调用提示方法（`showToast`）提示 “先修课未通过，无法选课”；若名额不足，则提示 “课程已满员”。校验通过后，启动数据库事务，分别执行课程表（`course`）中学科名额加 1 操作和学生选课表（`studentCourse`）中添加选课记录操作，事务提交成功则提示 “选课成功”，失败则回滚事务并提示 “选课失败，请重试”。

**退课函数**：`cancelCourse`函数接收选课记录 ID（`studentCourseId`），通过该 ID 获取对应课程 ID（`courseId`），启动数据库反向事务，将课程表（`course`）中的`currentStudent`减 1，并将学生选课表（`studentCourse`）中对应记录的`status`更新为 “退课”（`status=2`），事务提交成功则提示 “退课成功”。

**异常处理**：

选课开放期外，将 “选课” 按钮置灰，点击时调用提示方法（`showToast`）提示 “当前不在选课周期内”。

事务提交失败时（如网络中断），自动回滚操作，避免数据不一致。

### 模块三：补课退课管理

#### （1）功能简述

学生在非选课开放期（如学期中）因特殊原因（如课程冲突、身体不适）申请补选或退课，需填写申请理由并上传证明材料（如医院诊断书），提交后由院系管理员审核；学生可查看申请进度（待审核 / 通过 / 驳回），审核通过后系统自动更新选课状态。

#### （2）应用场景简述

**场景 1**：学生因转专业需补选新专业必修课程，在 “补课退课申请” 中提交申请，附上转专业证明。

**场景 2**：学生因实习冲突无法参加某门课程，申请退课并填写实习证明，管理员审核通过后释放名额。

**场景 3**：管理员批量处理积压的补退课申请，对不符合条件的申请驳回并附理由（如 “超过补退课截止时间”）。

#### （3）设计思路

**设计目标**：建立 “特殊场景下的补退课流程”，通过申请 - 审核 - 执行闭环，确保流程合规性，同时支持证据链上传与状态跟踪。

**功能架构**：

**申请层**：提供表单填写（申请类型 - 补选 / 退课、课程 ID、理由、附件上传），限制申请时间（如仅限开学后 2 周内）。

**审核层**：管理员端显示待审核列表，支持 “通过”“驳回” 操作，驳回时需填写理由（如 “先修课未通过”）。

**执行层**：审核通过后，自动触发选课 / 退课事务（同模块二逻辑），并发送通知（微信模板消息）给学生。

#### （4）具体实现

**数据来源与结构**：

补退课申请表`applyForm`字段：`_id`、`studentId`、`courseId`、`type`（0 - 补选，1 - 退课）、`reason`、`status`（0 - 待审核，1 - 通过，2 - 驳回）、`attachments`（附件 URL 数组）、`reviewTime`（审核时间）、`reviewer`（管理员 ID）。

**核心流程**：

学生进入 “补退课申请” 页，填写表单（选择申请类型`type`、课程 ID`courseId`、理由`reason`），上传附件（`attachments`），点击 “提交” 触发`submitApply`函数，在补退课申请表（`applyForm`）中生成一条申请记录，状态为 “待审核”（`status=0`）。

管理员在后台收到申请通知，进入审核页面，查看申请记录详情，通过`reviewApply`函数选择 “通过” 或 “驳回”：

若 “通过”，调用模块二的`submitCourse`（补选）或`cancelCourse`（退课）函数（跳过选课周期校验，但保留先修课 / 名额校验）。

若 “驳回”，使用`update`方法更新`applyForm`表中对应记录的`status`为 2，并填写`reviewReason`字段。

学生在 “申请记录” 页通过查询`applyForm`表，查看申请状态，审核通过后跳转至 “已选课程” 页，状态同步更新。

#### （5）关键代码实现描述

**提交补退课申请**：`submitApply`函数获取用户填写的申请类型（`type`）、课程 ID（`courseId`）、理由（`reason`）以及上传附件的 URL 数组（`attachments`），并从用户信息存储对象中获取学生 ID（`studentId`）。校验表单信息完整后，在补退课申请表（`applyForm`）中插入一条新记录，包含上述信息，状态设置为 “待审核”（`status=0`），提交成功后提示 “申请提交成功，等待审核”。

**管理员审核逻辑**：`reviewApply`函数接收申请记录 ID（`applyId`）、审核状态（`status`）和审核理由（`reason`）。根据`status`判断审核结果，若为 “通过”（`status=1`），则根据申请类型（`type`）调用模块二的`submitCourse`（补选）或`cancelCourse`（退课）函数执行选课或退课操作；若为 “驳回”（`status=2`），则使用`update`方法更新补退课申请表（`applyForm`）中对应记录的状态和审核理由字段。审核完成后，调用发送模板消息的云函数（`sendTemplateMessage`）向学生发送审核结果通知。

**异常处理**：

附件上传超过 3 张时，调用提示方法（`showToast`）提示 “最多上传 3 张证明材料”。

非补退课时间窗口，隐藏 “申请” 按钮并提示 “补退课通道已关闭”。

### 模块四：生成教学班级

#### （1）功能简述

管理员在学期初通过后台操作，根据课程选课结果（`studentCourse`表中状态为 “已选” 的记录）自动生成教学班级，支持按课程容量、专业、班级类型（如行政班 / 教学班）分组；生成后自动分配班主任（教师）和教室，并同步至学生课表与教师授课表。

#### （2）应用场景简述

**场景 1**：教务处管理员在选课结束后，对全校选修课（如 “大学英语”）按专业 + 人数（≤50 人 / 班）自动分班，生成 “大学英语 1 班”“大学英语 2 班” 等。

**场景 2**：教师申请新开实验课，管理员在系统中手动触发 “生成班级” 流程，根据选课学生的年级和实验室容量分配班级。

**场景 3**：分班后发现教室冲突，管理员可手动调整班级教室，系统自动同步更新学生课表中的上课地点。

#### （3）设计思路

**设计目标**：实现 “选课结果→教学班级” 的自动化映射，解决传统人工分班效率低、易出错的问题，支持灵活的分班规则（如按专业、人数上限）。

**功能架构**：

**分班规则**：

基础规则：同一课程下，按学生专业分组（如 “计算机专业”“软件工程专业”），每组不超过`maxClassSize`（如 60 人）。

优先级规则：行政班学生优先分到同一班级（便于管理）。

**数据关联**：

班级表`class`关联课程表（`courseId`）、教师表（`teacherId`- 班主任）、教室表（`classroomId`）。

学生班级表`studentClass`记录学生所属班级，用于生成课表。

**操作入口**：管理员端提供 “一键生成班级” 按钮，支持筛选课程范围（如仅生成 “必修课” 班级）。

#### （4）具体实现

**数据来源与结构**：

班级表`class`字段：`_id`、`courseId`、`className`（如 “数据结构 1 班”）、`teacherId`、`classroomId`、`studentList`（学生 ID 数组）、`createTime`。

学生班级表`studentClass`字段：`studentId`、`classId`、`courseId`、`term`（学期）。

**核心流程**：

管理员选择需分班的课程（支持多选，课程 ID 数组为`courseIds`），设置分班规则（如`maxClassSize=60`，按专业分组），点击 “生成班级” 触发`generateClass`函数。

`generateClass`函数遍历`courseIds`，对每门课程：

从学生选课表（`studentCourse`）中查询该课程下所有状态为 “已选”（`status=1`）的学生记录，获取学生列表。

使用`groupBy`函数按学生专业（`major`字段）对学生进行分组。

对每个专业分组，根据`maxClassSize`计算班级数量，并为每个班级分配名称（如 “课程名称 + 序号 + 班”）。

#### （5）关键代码实现描述

**一键生成班级主函数**：generateClass 函数接收需分班的课程 ID 数组 courseIds。函数遍历每个 courseId，先从学生选课表 studentCourse 中，通过 where 条件筛选出该课程下状态为 “已选”（status = 1）的学生记录，调用 get 方法获取学生列表数据。接着使用自定义的 groupBy 函数，按照学生的 major（专业）字段对学生进行分组。对于每个专业分组，计算需要拆分的班级数量 classCount（通过学生人数除以班级最大容量 maxClassSize 并向上取整）。在循环创建班级过程中，确定每个班级学生的起止索引 start 和 end，生成班级名称 className（课程名称 + 序号 + “班”）。随后，在教室表 classroom 中，通过 where 条件筛选出容量大于等于 maxClassSize 的可用教室，获取第一个教室的 ID classroomId。最后，在班级表 class 中使用 add 方法添加班级记录，包含课程 ID courseId、班级名称 className、教师 ID teacherId（关联课程的授课教师）、教室 ID classroomId、学生 ID 数组 studentList 等信息；同时，针对每个班级的学生，在学生班级表 studentClass 中使用 add 方法添加学生与班级的关联记录，包括学生 ID studentId、班级 ID classId、课程 ID courseId 以及学期 term。

**自定义分组函数**：groupBy 函数接收学生数组 array 和分组依据字段 key（如 major）。通过 reduce 方法遍历数组，以学生的 key 值（专业）为分组依据，将具有相同 key 值的学生添加到对应的分组数组中，最终返回一个以专业为键、学生数组为值的分组对象。

**异常处理**：

在分配教室环节，若通过筛选条件在教室表 classroom 中未查询到可用教室，系统调用提示方法（showToast）显示 “该课程时间暂无足够容量的教室，请手动分配”，并停止当前班级生成流程，允许管理员手动干预。

当学生数据中缺失专业信息时，系统将这些学生默认归入 “其他专业” 分组，避免因数据不完整导致整个分组逻辑中断，确保班级生成流程能够继续执行。